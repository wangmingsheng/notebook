var Task = require('../modules/task/Index');
var ModuleManage = require('../modules/Manage');
var MemberData = require('../data/Member');
var moduleIndex = 0;

module.exports = React.createClass({
	isSwitch: false,
	create: function(module) {
		if (!module) return {module: null, key: ++moduleIndex};
		return {module: module, key: 'pre' + ++moduleIndex};
	},
	switchModule: function(module, direction) {
		this.isSwitch = true;
		Utils.screenState(true);

		this.setState({next: this.create(module)});
		var nextCss = {transition: 'left .4s'};
		if (direction) nextCss.left = '-100%';
		var nextP = $(this.refs.next).css(nextCss);

		setTimeout(function() {
			var current = $(this.refs.current);
			var next = $(this.refs.next);
			current.css('left', direction ? '100%' : '-100%');
			next.css('left', '0%');
			next.on('transitionend', function() {
				this.isSwitch = false;
				Utils.screenState(false);
				next.off('transitionend');

				nextP.css('transition', null);
				this.setState({current: this.state.next, next: this.create()});
			}.bind(this));
		}.bind(this));
	},
	preventEvent: function(e) {
		if(!Config.locked) return true;
		e.stopPropagation();
	},
	lockedEvent: function(e) {
		if(!Config.locked) return true;
		e.preventDefault();
	},
	backEvent: function(e) {
		if(!Config.locked || $(e.target).is('[data-lock]')) return true;
		e.preventDefault();
		e.stopPropagation();
		Event.trigger('ReleaseLock');
	},
	componentDidMount: function() {
		var objWindow = $(window);

		objWindow.on('popstate', function(e) {
			var url = location.href.replace(location.origin, '');
			ModuleManage.getModule(url, function(Virtual) {
				this.switchModule(<Virtual />, true);
			}.bind(this));
		}.bind(this));

		window.addEventListener('touchmove', this.lockedEvent, true); // 锁定状态下屏幕上下滑动

		window.addEventListener('touchstart', this.preventEvent, true); // 锁定状态阻止事件冒泡

		// 锁定状态下回滚
		window.addEventListener('click', this.backEvent, true); 
		window.addEventListener('touchstart', this.backEvent, true);

		Event.on('SwitchModule', function(module, driection) {
			if (this.isSwitch) return false;
			setTimeout(function() { this.switchModule(module, driection); }.bind(this));
		}.bind(this));

		Config.elect_team = Interface.getTeamId();
		if (!Config.elect_team) {
			return Forms.post({
				uri: '/token?id=500bb48bf6cf49a9&secret=675809b580d0458e815c9b31a3f12e93',
				params: {name: '13655022584', password: '545c517179861604'},
				callback: function(result) {
					Config.accessToken = result.data.access_token;
					Forms.get({
						uri: '/user/profile',
						callback: function(result) {
							Config.elect_team = result.data.elect_team;
							MemberData.getList(Config.elect_team);
							this.setState({current: this.create(<Task />)})
						}.bind(this)
					})
				}.bind(this)
			})
		}
		MemberData.getList(Config.elect_team);
		this.setState({current: this.create(<Task />)});
	},
	getInitialState: function() {
		//Config.elect_team = Interface.getTeamId();
		return {
			current: this.create(),
			next: this.create()
		};
	},
	render: function() {
		return (<div className="module_box">
					<div className="module_current" ref="current" key={this.state.current.key}>
						{this.state.current.module}
					</div>
					<div className="module_next" ref="next" key={this.state.next.key}>
						{this.state.next.module}
					</div>
				</div>);
	}
});