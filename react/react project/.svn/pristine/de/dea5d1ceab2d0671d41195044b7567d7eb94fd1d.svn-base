var Task = require('../modules/task/Index');
var moduleIndex = 0;

module.exports = React.createClass({
	isSwitch: false,
	create: function(module) {
		if (!module) return {module: null, key: null};
		return {module: module, key: 'pre' + ++moduleIndex};
	},
	switchModule: function(module, direction) {
		this.state.next = this.create(module);
		this.isSwitch = true;

		this.setState(this.state);
		var nextCss = {transition: 'left .4s'};
		if (direction) nextCss.left = '-100%';
		var nextP = $(this.refs.next).css(nextCss);

		setTimeout(function() {
			var current = $(this.refs.current);
			var next = $(this.refs.next);
			current.css('left', direction ? '100%' : '-100%');
			next.css('left', '0%');
			next.on('transitionend', function() {
				this.isSwitch = false;
				next.off('transitionend');

				nextP.css('transition', null);
				this.state.current = this.state.next;
				this.state.next = this.create();
				this.setState(this.state);
			}.bind(this));
		}.bind(this));
	},
	componentDidMount: function() {
		var objWindow = $(window);

		objWindow.on('popstate', function() {
			alert(location.href);
		}.bind(this));

		objWindow.on('touchmove', function(event) {
			if (true) event.preventDefault();	
		});

		Event.on('SwitchModule', function(module, driection) {
			if (this.isSwitch) return false;
			setTimeout(function() { this.switchModule(module, driection); }.bind(this));
		}.bind(this));
	},
	getInitialState: function() {
		Config.elect_team = Interface.getTeamId();
		return {
			current: this.create(<Task />),
			next: this.create()
		};
	},
	render: function() {
		return (<div className="module_box">
					<div className="module_current" ref="current" key={this.state.current.key}>
						{this.state.current.module}
					</div>
					<div className="module_next" ref="next" key={this.state.next.key}>
						{this.state.next.module}
					</div>
				</div>);
	}
});