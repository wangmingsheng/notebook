var TaskHandle = require('../../handle/teamwork/Task');
var MemberData = require('../../data/Member');

module.exports = React.createClass({
    componentDidMount: function() {
        TaskHandle.getTaskComments(this.props.topicId, function(result) {
            if(result.code == 200) {
                this.setState({source: result.data || []});
                return true;
            }
        }.bind(this));
    },
    getUrl: function(id, type) {
        var other = '?medium=2';
        if(type) other = '?download=1';
        return 'https://box.facework.im/api/teams/'+ Config.elect_team +'/attachments/' + id + other;
    },
    voiceClick: function(e) {
        this.state.voicePlay = !this.state.voicePlay;
        var dom = $(e.currentTarget).find('audio')[0];
        if(!this.state.voicePlay) {
           return dom.pause();
        }
        dom.currentTime = 0;
        dom.play();
    },
    audioEnded: function(e) {

    },
    videoLoadState: function() {
        console.log('startLoading ')
    },
    loaded: function() {
        console.log('loaded');
        Interface.alert('loaded')
    },
    getInitialState: function() {
        return {source: [], voicePlay: false };
    },
    render: function() {
        return <div className="chat">
            <ul>
                {
                    this.state.source.map(function(item, index) {
                        var data = MemberData.source[item.creator];
                        var attachment = null;
                        switch(item.body.attachment && item.body.attachment.assort) {
                            case null:
                                break;
                            case 0:
                                switch(item.body.attachment.ext) {
                                    case 'mp4':
                                        attachment =  <div className="video_box">
                                                <video controls="controls" onError={this.loaded}>
                                                    <source src={this.getUrl(item.body.attachment._id, 1)} />
                                                    <p>你的浏览器不支持此元素</p>
                                                </video>
                                        </div>;
                                        break;
                                    case 'mp3':
                                    case 'Wav':
                                        attachment =  <div className="voice_box">
                                            <div className="tag" style={{width: 40 + "%"}} onClick={this.voiceClick}>
                                                <i>&gt;&gt;</i>
                                                <audio controls="controls" onEnded={this.audioEnded}>
                                                    <source src={this.getUrl(item.body.attachment._id, 1)} />
                                                    <p>你的浏览器不支持此元素</p>
                                                </audio>
                                            </div>
                                            <span className="duration">15</span>
                                        </div>;
                                        break;
                                    default:
                                        attachment = <div className="download_box">
                                            <img src={"/assets/file_icons/" + item.body.attachment.ext + ".png"} alt=""/>
                                            <span className="message">
                                                <div className="title">{item.body.attachment.title}</div>
                                                <div className="size">{item.body.attachment.size/1000 + 'KB'}</div>
                                            </span>
                                            <i className="operate"><a href={this.getUrl(item.body.attachment._id, 1)}></a></i>
                                        </div>;
                                }
                                break;
                            case 1:
                                attachment = <img src={this.getUrl(item.body.attachment._id)} alt=""/>;
                                break;
                            case 2:
                                break;
                            case 3:
                                break;

                        }
                        return <li key={index}>
                            <i className="avatar"><img src={data.avatar} /></i>
                            <div className="content">
                                <div className="owner_info">
                                    <span>{data.display_name}</span>
                                    <label>{Utils.formatDate(item.create_time, 'YYYY年MM月DD日')}</label>
                                    <label>{Utils.filterHHmm00(Utils.formatDate(item.create_time, 'hh:mm'))}</label>
                                </div>
                                {attachment}
                                <p>{item.body.content}</p>
                            </div>
                        </li>
                    }.bind(this))
                }
            </ul>
            {
                this.state.source.length > 0 ? null : <div className="warning"><span>暂无评论</span></div>
            }
        </div>
    }
});

/*
 <li>
 <i className="avatar"><img src="../../../assets/images/member1.png" /></i>
 <div className="content">
 <div className="owner_info">
 <span>Sunny</span>
 <label>2016年9月18日</label>
 <label>18:30</label>
 </div>
 <div className="voice">
 <div className="tag" style={{width: 40 + "%"}}>
 <div className="arrow">
 <em></em>
 <span></span>
 </div>
 <i>&gt;&gt;</i>
 <span className="duration">15</span>
 </div>
 </div>
 </div>
 </li>
 <li>
 <i className="avatar"><img src="../../../assets/images/member1.png" /></i>
 <div className="content first_login others">
 <div className="owner_info">
 <span>Andy</span>
 <label>18:30</label>
 </div>
 <strong>欢迎您使用Facework</strong>
 <div className="voice">
 <div className="tag" style={{width: 20 + "%"}}>
 <div className="arrow">
 <em></em>
 <span></span>
 </div>
 <i>&gt;&gt;</i>
 <span className="duration">15</span>
 </div>
 </div>
 </div>
 </li>
 <li>
 <i className="avatar"><img src="../../../assets/images/member2.png" /></i>
 <div className="content">
 <div className="owner_info">
 <span>Sunny</span>
 <label>2016年9月18日</label>
 <label>18:30</label>
 </div>
 <p>Welcome to the community documentation wiki for</p>
 </div>
 </li>
* */